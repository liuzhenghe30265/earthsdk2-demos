<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script src="../../../../js/earthsdk.js"></script>
    <!-- 自定义Css样式 -->
    <link rel="stylesheet" href="../../../../css/example1.css">
    <title>Cesium地球初始化</title>
    <style>
        html,
        body,
        #app {
            width: 100%;
            height: 100%;
            margin: 0px;
            padding: 0px;
        }

        .box {
            margin-top: 30px;
        }

        .box>div {
            display: grid;
            grid-template-columns: 115px 1fr;
            align-items: center;
        }

        .box>button {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div id="app"></div>
    <div id="panel">
        <H3>ESUnrealActor两种创建方式</H3>
        <div class="box">
            <button onclick="flyIn()">飞入UE的初始视角</button>
        </div>
        <div class="box">
            <p>根据UE资源路径创建</p>
            <div><label for="">UE引用路径：</label><input id="actorClass" type="text"></div>
            <button onclick="createFromActorClass()">开始创建</button>
        </div>
        <div class="box">
            <p>绑定场景已存在的Actor</p>
            <label for="">鼠标拾取tag：</label> <input id="pick" type="checkbox" checked="true" onchange="changePick()">
            <div><label>Actor标识tag：</label><input id="actorTag" type="text"></div>
            <button onclick="createFromActorTag()">开始创建</button>
        </div>
    </div>
    <script>
        /** ---------------------------------地球创建------------------------------------**/

        // Vue中引入方式：import { ESObjectsManager } from 'esobjs-xe2-plugin/dist-node/esobjs-xe2-plugin-main';

        const { ESObjectsManager } = XE2['esobjs-xe2-plugin-main']
        const objm = new ESObjectsManager();
        window.g_objm = objm;

        var enablePick = true

        // 监听视口创建完成事件
        objm.viewerCreatedEvent.don((viewer) => {
            // 参考pick示例
            viewer.clickEvent.don((e) => {
                viewer.pick(e.screenPosition, 'customPick').then(res => {
                    if (res.childPickedInfo.attachedInfo == 'customPick') {
                        if (viewer.typeName == 'ESUeViewer' && enablePick) {
                            // 根据UE的拾取信息获取对应的actorTag信息
                            if (res && Array.isArray(res.actorTags) && res.actorTags.length > 0) {
                                document.getElementById('actorTag').value = res.actorTags[0];
                            }
                        }
                    }
                })
            })
        })
        // 创建Cesium视口
        const viewer = objm.createCesiumViewer({
            "domid": document.getElementById("app")
        })
        // 监听视口状态
        viewer.statusChanged.don(status => {
            if (status == 'Created') {
                // 视口创建完成，飞到初始视角位置
                objm.activeViewer.flyIn([113.8449897450312, 24.72056403496844, 12610.19688138856], [326.30376594361803, -47.46422069402949, 359.63379805527984], 3)
            }
        })

        // 通过json创建一个影像图层
        const imageryLayer = objm.createSceneObjectFromJson({
            "id": "9812a65f-0de0-4f7b-b234-809c0c2fb8ef",
            "type": "ESImageryLayer",
            "url": "https://webmap.giiiis.com/maps/vt?lyrs=s&x={x}&y={y}&z={z}"
        });



        // 是否可拾取
        function changePick() {
            enablePick = document.getElementById("pick").checked
        }

        /** ---------------------------------!!!actor仅支持UE引擎------------------------------------**/

        // 飞到初始视角
        function flyIn() {
            if (objm.activeViewer.typeName != 'ESUeViewer') {
                alert('当前视口不支持创建UE Actor，请切换UE视口')
                return
            }
            objm.activeViewer.defaultCameraFlyIn()
        }

        const { ESUnrealActor } = XE2['esobjs-xe2-plugin-main']
        // 根据UE资产创建Actor
        function createFromActorClass() {
            if (objm.activeViewer.typeName != 'ESUeViewer') {
                alert('当前视口不支持创建UE Actor，请切换UE视口')
                return
            }
            let actorClass = document.getElementById("actorClass").value
            if (!actorClass) {
                alert('请填写UE的Actor对应的资源引用路径')
                return
            }
            const actor = objm.createSceneObject(ESUnrealActor)
            actor.actorClass = actorClass
            actor.editing = true
        }


        // 创建Actor绑定场景现有的Actor
        function createFromActorTag() {
            if (objm.activeViewer.typeName != 'ESUeViewer') {
                alert('当前视口不支持创建UE Actor，请切换UE视口')
                return
            }
            let actorTag = document.getElementById("actorTag").value
            if (!actorTag) {
                alert('请填写场景种已有的Actor的标识符tag')
                return
            }
            // 所有对象以以js为主，因此要获取UE端存在的Actor的位置、姿态等信息，不然就会设置到0，0，0位置点
            objm.activeViewer.getObjectByInfo({ actorTag: actorTag, componentTag: "" }).then(res => {
                console.log(res)
                if (!res) {
                    alert('该tag无效或者重复');
                    return
                } else {
                    const actor = objm.createSceneObject(ESUnrealActor)
                    actor.actorTag = actorTag
                    actor.position = res.position
                    actor.rotation = res.rotation
                    actor.highlight = true
                    actor.editing = true
                }
            }).catch((error) => {
                console.log(error);

            })

        }


    </script>

    <!-- 切换UE和Cesium引擎的组件（Vue） -->
    <div id="root">
        <switch-engine :objm="objm"></switch-engine>
    </div>
    <!-- Vue文件 -->
    <script src="../../../../js/vue.global.js"></script>
    <!-- 切换UE和Cesium的组件 -->
    <script src="../../../../js/switchEngineCom.js"></script>
</body>

</html>